<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>筋肉バスターズ 速報</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      .event-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
        margin: 8px 20px 0;
      }
      .unit {
        font-size: 14px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h1>筋肉バスターズ 種目別 速報</h1>
    <div id="events" class="ranking"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const EVENTS = [
        { key: 'grip', label: '握力', unit: 'kg' },
        { key: 'situp30', label: '上体起こし（30秒）', unit: '回' },
        { key: 'wallSit', label: '空気椅子', unit: '秒' },
        { key: 'pushup60', label: '腕立て伏せ（1分）', unit: '回' },
        { key: 'backExt', label: '背筋測定', unit: 'kg' },
        { key: 'yoga60', label: 'ヨガポーズ（60秒）', unit: '秒' },
      ];

      const colorMap = {
        RED: '#ff3333',
        BLUE: '#3399ff',
        YELLOW: '#ffcc00',
        GREEN: '#33cc66',
      };

      let maxConfig = {};

      const socket = io();
      socket.on('teamsUpdated', (teams) => {
        render(teams, maxConfig);
      });

      async function fetchTeams() {
        const res = await fetch('/api/teams');
        return await res.json();
      }

      async function fetchMax() {
        const res = await fetch('/api/muscle-max');
        if (!res.ok) return {};
        return await res.json();
      }

      function render(teams, maxObj) {
        const root = document.getElementById('events');
        root.innerHTML = '';

        EVENTS.forEach((ev) => {
          // 各チームの値を集めて降順ソート
          const ranked = (teams || [])
            .map((t) => ({
              name: t.name,
              val: t.events?.[ev.key] ?? 0,
            }))
            .sort((a, b) => b.val - a.val);

          // 上位3位まで抽出（値が同じ場合は同順位: 1,1,3...）
          let prevVal = null;
          let prevRank = 0;
          const ranks = [];
          ranked.forEach((t, i) => {
            if (prevVal !== null && t.val === prevVal) {
              ranks[i] = prevRank;
            } else {
              ranks[i] = i + 1;
              prevVal = t.val;
              prevRank = ranks[i];
            }
          });

          const top3 = ranked.slice(0, 3);

          const section = `
            <div class="event-title">${ev.label}</div>
            ${top3
              .map(
                (t, i) => `
                <div class="rank-item">
                  <div class="rank-left">
                    <div class="rank-num" style="background:${
                      colorMap[t.name] || '#999'
                    };">${ranks[i]}</div>
                  </div>
                  <div class="team-name">${t.name}</div>
                  <div class="score">${t.val}${ev.unit}</div>
                </div>
              `
              )
              .join('')}
          `;
          root.insertAdjacentHTML('beforeend', section);
        });
      }

      async function init() {
        maxConfig = await fetchMax();
        const teams = await fetchTeams();
        render(teams, maxConfig);
      }

      init();
    </script>
  </body>
</html>
