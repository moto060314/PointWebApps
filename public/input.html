<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>スコア入力</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      .section-title {
        max-width: 700px;
        margin: 16px auto 8px;
        font-weight: bold;
        color: #444;
      }
      .inline {
        display: inline-block;
        min-width: 220px;
      }
    </style>
  </head>
  <body>
    <h1>スコア入力フォーム</h1>

    <div class="section-title">チーム別スコア</div>
    <form id="scoreForm" class="team-grid"></form>

    <div class="section-title">コスプレ投票数</div>
    <form id="cosplayForm"></form>

    <button id="saveBtn" type="button">保存</button>
    <p id="msg" style="text-align: center; color: green"></p>
    <script>
      const EVENTS = [
        { key: 'grip', label: '握力（kg）' },
        { key: 'situp30', label: '上体起こし（30秒）' },
        { key: 'wallSit', label: '空気椅子（秒）' },
        { key: 'pushup60', label: '腕立て伏せ（1分）' },
        { key: 'backExt', label: '背筋測定（kg）' },
        { key: 'yoga60', label: 'ヨガポーズ（60秒）' },
      ];

      // 採点関数群
      function scoreGrip(val, broken) {
        if (broken) return 100;
        if (val >= 81) return 10;
        if (val >= 56) return 3;
        if (val >= 41) return 2;
        if (val > 0) return 1; // 0は加点しない
        return 0;
      }
      function scoreSitup30(val) {
        if (val >= 51) return 10;
        if (val >= 31) return 6;
        if (val >= 21) return 2;
        if (val > 0) return 1; // 0は加点しない
        return 0;
      }
      function scoreWallSit(val) {
        if (val >= 101) return 7;
        if (val >= 71) return 3;
        if (val >= 46) return 2;
        if (val > 0) return 1; // 0は加点しない
        return 0;
      }
      function scorePushup60(val) {
        if (val >= 85) return 20; // 85~ は 86以上と解釈
        if (val >= 51) return 3;
        if (val >= 36) return 2;
        if (val > 0) return 1; // 0は加点しない
        return 0;
      }
      function scoreBackExt(val, broken) {
        if (broken) return 100;
        if (val >= 196) return 10;
        if (val >= 166) return 5;
        if (val >= 140) return 3;
        if (val > 0) return 1; // 0は加点しない
        return 0;
      }
      // yogaPose: 0=未選択/なし, 1..4
      function scoreYoga(seconds, yogaPose) {
        const sec = Number(seconds);
        const pose = Number(yogaPose);

        // 入力があれば参加点5p
        const base = sec > 0 || pose > 0 ? 5 : 0;

        // 60秒未満は参加点のみ（ポーズ加点なし）
        if (sec < 60) return base;

        // 60秒以上でポーズ加点
        switch (pose) {
          case 1:
          case 2:
            return base + 5;
          case 3:
            return 500; // 参加点加算なし
          case 4:
            return 100; // 参加点加算なし
          default:
            return base;
        }
      }

      function calcMuscleFromDom(teamName) {
        const num = (id) => {
          const el = document.getElementById(id);
          if (!el) return 0;
          const v = el.value;
          if (v === '' || v === null || v === undefined) return 0;
          const n = Number(v);
          return Number.isFinite(n) ? n : 0;
        };
        const bool = (id) => Boolean(document.getElementById(id)?.checked);

        const grip = num(`${teamName}-grip`);
        const situp30 = num(`${teamName}-situp30`);
        const wallSit = num(`${teamName}-wallSit`);
        const pushup60 = num(`${teamName}-pushup60`);
        const backExt = num(`${teamName}-backExt`);
        const yoga60 = num(`${teamName}-yoga60`);
        const yogaPose = num(`${teamName}-yogaPose`);

        const gripBroken = bool(`${teamName}-gripBroken`);
        const backExtBroken = bool(`${teamName}-backExtBroken`);

        const total =
          scoreGrip(grip, gripBroken) +
          scoreSitup30(situp30) +
          scoreWallSit(wallSit) +
          scorePushup60(pushup60) +
          scoreBackExt(backExt, backExtBroken) +
          scoreYoga(yoga60, yogaPose);

        return {
          total,
          events: {
            grip,
            situp30,
            wallSit,
            pushup60,
            backExt,
            yoga60,
            yogaPose,
            gripBroken,
            backExtBroken,
          },
        };
      }

      function updateMuscleDisplay(teamName) {
        const { total } = calcMuscleFromDom(teamName);
        const el = document.getElementById(`${teamName}-mus-calc`);
        if (el) el.textContent = String(total);
      }

      async function loadTeams() {
        const res = await fetch('/api/teams');
        const teams = await res.json();
        const form = document.getElementById('scoreForm');
        form.innerHTML = teams
          .map((team) => {
            const ev = team.events || {};
            const yogaPose = Number(ev.yogaPose ?? 0);
            return `
              <div class="form-item team-card team-${team.name}">
                <h3>${team.name}</h3>
                コスプレ：<input type="number" id="${
                  team.name
                }-cos" value="${Number(team.cosplay)}" /> pt
                <br />
                筋肉（自動計算）：<strong><span id="${
                  team.name
                }-mus-calc">0</span> pt</strong>
                <hr />
                握力計 壊した：<input type="checkbox" id="${
                  team.name
                }-gripBroken" ${ev.gripBroken ? 'checked' : ''} />
                ／ 背筋計 壊した：<input type="checkbox" id="${
                  team.name
                }-backExtBroken" ${ev.backExtBroken ? 'checked' : ''} />
                <br />
                ヨガポーズ：
                <select id="${team.name}-yogaPose">
                  <option value="0" ${
                    yogaPose === 0 ? 'selected' : ''
                  }>選択なし</option>
                  <option value="1" ${
                    yogaPose === 1 ? 'selected' : ''
                  }>ポーズ1 (+5)</option>
                  <option value="2" ${
                    yogaPose === 2 ? 'selected' : ''
                  }>ポーズ2 (+5)</option>
                  <option value="3" ${
                    yogaPose === 3 ? 'selected' : ''
                  }>ポーズ3 (+500)</option>
                  <option value="4" ${
                    yogaPose === 4 ? 'selected' : ''
                  }>ポーズ4 (+100)</option>
                </select>
                <hr />
                ${EVENTS.map(
                  (e) =>
                    `${e.label}：<input type="number" id="${team.name}-${
                      e.key
                    }" value="${
                      ev[e.key] && Number(ev[e.key]) !== 0
                        ? Number(ev[e.key])
                        : ''
                    }" />`
                ).join('<br />')}
              </div>
            `;
          })
          .join('');

        // 初期表示の自動計算＆入力変更時の再計算
        teams.forEach((team) => {
          updateMuscleDisplay(team.name);
          const ids = [
            'cos',
            'grip',
            'situp30',
            'wallSit',
            'pushup60',
            'backExt',
            'yoga60',
            'yogaPose',
            'gripBroken',
            'backExtBroken',
          ].map((k) => `${team.name}-${k}`);
          ids.forEach((id) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('input', () => updateMuscleDisplay(team.name));
            el.addEventListener('change', () => updateMuscleDisplay(team.name));
          });
        });
      }

      async function loadCosplayVotes() {
        const res = await fetch('/api/cosplay');
        const votes = await res.json();
        const form = document.getElementById('cosplayForm');
        const teamOptions = ['RED', 'BLUE', 'YELLOW', 'GREEN']
          .map((t) => `<option value="${t}">${t}</option>`)
          .join('');
        form.innerHTML = votes
          .map(
            (v, i) =>
              `<div class="form-item">
                <input type="text" id="cosplayer-${i}-name" value="${v.name}" placeholder="コスプレイヤー名" />
                投票数：<input type="number" id="cosplayer-${i}-votes" value="${v.votes}" />
                チーム：<select id="cosplayer-${i}-team">
                  <option value="">未選択</option>
                  ${teamOptions}
                </select>
              </div>`
          )
          .join('');
        // チーム初期値セット
        votes.forEach((v, i) => {
          const sel = document.getElementById(`cosplayer-${i}-team`);
          if (sel && v.team) sel.value = v.team;
        });
      }

      // 保存ボタンの処理
      async function saveAll() {
        const res = await fetch('/api/teams');
        let teams = await res.json();

        teams = teams.map((team) => {
          const { total, events } = calcMuscleFromDom(team.name);
          return {
            name: team.name,
            cosplay: Number(document.getElementById(`${team.name}-cos`).value),
            muscle: total, // 自動計算
            events,
          };
        });

        // コスプレ投票数保存
        const cosplayForm = document.getElementById('cosplayForm');
        const cosplayers = [];
        for (let i = 0; i < cosplayForm.children.length; i++) {
          const name = document.getElementById(`cosplayer-${i}-name`).value;
          const votes = Number(
            document.getElementById(`cosplayer-${i}-votes`).value
          );
          const team = document.getElementById(`cosplayer-${i}-team`).value;
          if (name) cosplayers.push({ name, votes, team });
        }
        await fetch('/api/cosplay', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(cosplayers),
        });

        const saveTeams = await fetch('/api/teams', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(teams),
        });

        if (saveTeams.ok) {
          document.getElementById('msg').innerText = '✅ 保存しました！';
        }
      }

      document.getElementById('saveBtn').addEventListener('click', saveAll);

      // Ctrl+Shift+Enter または Cmd+Shift+Enter で保存
      document.addEventListener('keydown', function (e) {
        const isMac = navigator.platform.toLowerCase().includes('mac');
        const ctrlOrCmd = isMac ? e.metaKey : e.ctrlKey;
        if (ctrlOrCmd && e.shiftKey && e.key === 'Enter') {
          e.preventDefault();
          saveAll();
        }
      });

      (async () => {
        await loadTeams();
        await loadCosplayVotes();
      })();
    </script>
  </body>
</html>
